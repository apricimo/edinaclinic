<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Appointment - Edina Clinic</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f7fa; color: #333; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 10px; margin-bottom: 2rem; text-align: center; }
        .back-btn { background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-bottom: 20px; text-decoration: none; display: inline-block; }
        .service-info, .booking-section, .payment-section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .service-dropdown, .provider-dropdown { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1rem; background: white; cursor: pointer; }
        .service-dropdown:focus, .provider-dropdown:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1); }
        .service-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; }
        .service-price { font-size: 1.3rem; color: #28a745; font-weight: bold; margin-bottom: 10px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .calendar-nav { background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
        .month-year { font-size: 1.2rem; font-weight: bold; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 20px; }
        .day-header { text-align: center; font-weight: bold; padding: 10px; background: #f8f9fa; border-radius: 4px; color: #666; }
        .calendar-day { text-align: center; padding: 12px; border-radius: 4px; cursor: pointer; transition: all 0.2s; border: 1px solid #e0e0e0; background: white; }
        .calendar-day.other-month { color: #ccc; background: #fafafa; cursor: not-allowed; }
        .calendar-day.available { background: #e8f5e9; border-color: #4caf50; color: #2e7d32; }
        .calendar-day.selected { background: #007bff; color: white; border-color: #007bff; }
        .calendar-day.unavailable { background: #f8f8f8; color: #ccc; cursor: not-allowed; }
        .times-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .time-slot { border: 2px solid #e0e0e0; border-radius: 8px; background: white; padding: 15px; text-align: center; transition: all 0.2s; }
        .time-slot.selected { border-color: #007bff; box-shadow: 0 0 0 2px rgba(0,123,255,0.2); }
        .time-text { font-weight: bold; font-size: 1.1rem; margin-bottom: 10px; color: #333; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 1rem; }
        .book-btn, .pay-btn { background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 15px 30px; border-radius: 6px; font-size: 1.1rem; cursor: pointer; width: 100%; margin-top: 20px; }
        .book-btn:disabled, .pay-btn:disabled { background: #ccc; cursor: not-allowed; }
        .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
        .success { background: #d4edda; color: #155724; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
        .debug-panel { background: #f8f9fa; border: 1px solid #e0e0e0; padding: 15px; border-radius: 6px; margin-top: 20px; font-family: monospace; font-size: 0.9rem; display: none; max-height: 300px; overflow-y: auto; }
        .appointment-summary { background: #f8f9fa; border: 1px solid #e0e0e0; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
        .summary-item { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .summary-item:last-child { margin-bottom: 0; font-weight: bold; border-top: 1px solid #e0e0e0; padding-top: 10px; }
        #card-element { padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; background: white; }
        .payment-steps { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; }
        .step { display: flex; align-items: center; margin: 0 10px; }
        .step-number { width: 30px; height: 30px; border-radius: 50%; background: #e0e0e0; color: #666; display: flex; align-items: center; justify-content: center; margin-right: 8px; font-weight: bold; }
        .step.active .step-number { background: #007bff; color: white; }
        .step.completed .step-number { background: #28a745; color: white; }
        .step-arrow { margin: 0 10px; color: #ccc; }
        @media (max-width: 768px) { .times-grid { grid-template-columns: 1fr; } .calendar-grid { gap: 3px; } .calendar-day { padding: 8px; font-size: 0.9rem; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Book Your Telehealth Appointment</h1>
        </div>

        <!-- Progress Steps -->
        <div class="payment-steps">
            <div class="step active" id="step-1">
                <div class="step-number">1</div>
                <span>Select Service</span>
            </div>
            <div class="step-arrow">→</div>
            <div class="step" id="step-2">
                <div class="step-number">2</div>
                <span>Choose Time</span>
            </div>
            <div class="step-arrow">→</div>
            <div class="step" id="step-3">
                <div class="step-number">3</div>
                <span>Payment</span>
            </div>
            <div class="step-arrow">→</div>
            <div class="step" id="step-4">
                <div class="step-number">4</div>
                <span>Confirmed</span>
            </div>
        </div>

        <a href="javascript:void(0)" onclick="goBack()" class="back-btn" id="back-btn" style="display: none;">← Back to Services</a>

        <div class="service-info">
            <div style="margin-bottom: 20px;">
                <label for="service-select">Select Service:</label>
                <select id="service-select" class="service-dropdown">
                    <option value="">Loading services...</option>
                </select>
            </div>
            <div id="service-details" style="display: none;">
                <div class="service-title" id="service-name"></div>
                <div class="service-price" id="service-price"></div>
                <div id="service-description"></div>
            </div>
        </div>

        <div id="error-message"></div>
        <div id="success-message"></div>

        <div class="booking-section" id="booking-section" style="display: none;">
            <h3>Select a date:</h3>
            
            <div class="calendar-header">
                <button class="calendar-nav" id="prev-month">‹</button>
                <div class="month-year" id="month-year">January 2025</div>
                <button class="calendar-nav" id="next-month">›</button>
            </div>
            
            <div class="calendar-grid" id="calendar-grid">
                <div class="day-header">Sun</div><div class="day-header">Mon</div><div class="day-header">Tue</div><div class="day-header">Wed</div><div class="day-header">Thu</div><div class="day-header">Fri</div><div class="day-header">Sat</div>
            </div>

            <div id="times-container" style="display: none;">
                <h3>Available times:</h3>
                <div class="times-grid" id="times-grid"></div>
            </div>

            <div id="patient-info" style="display: none;">
                <h3>Your Information:</h3>
                <form id="booking-form">
                    <div class="form-group">
                        <label for="patient-email">Email Address:</label>
                        <input type="email" id="patient-email" required>
                    </div>
                    <button type="submit" class="book-btn" id="book-btn" disabled>Continue to Payment</button>
                </form>
            </div>
        </div>

        <!-- Payment Section -->
        <div class="payment-section" id="payment-section" style="display: none;">
            <h3>Payment Information</h3>
            
            <div class="appointment-summary">
                <h4>Appointment Summary</h4>
                <div class="summary-item">
                    <span>Service:</span>
                    <span id="summary-service"></span>
                </div>
                <div class="summary-item">
                    <span>Date & Time:</span>
                    <span id="summary-datetime"></span>
                </div>
                <div class="summary-item">
                    <span>Provider:</span>
                    <span id="summary-provider"></span>
                </div>
                <div class="summary-item">
                    <span>Total:</span>
                    <span id="summary-total"></span>
                </div>
            </div>

            <form id="payment-form">
                <div class="form-group">
                    <label for="card-element">Credit or debit card</label>
                    <div id="card-element">
                        <!-- Stripe Elements will create form elements here -->
                    </div>
                    <div id="card-errors" role="alert" style="color: #dc3545; margin-top: 10px;"></div>
                </div>
                
                <button type="submit" class="pay-btn" id="pay-btn" disabled>
                    <span id="button-text">Pay Now</span>
                </button>
            </form>
        </div>

        <!-- Confirmation Section -->
        <div class="booking-section" id="confirmation-section" style="display: none;">
            <div class="success">
                <h3>🎉 Appointment Confirmed!</h3>
                <p>Your telehealth appointment has been successfully booked and paid for.</p>
                <div style="margin-top: 15px;">
                    <strong>Appointment ID:</strong> <span id="confirmation-id"></span><br>
                    <strong>Next Steps:</strong> You will receive a confirmation email with meeting details.
                </div>
            </div>
            <button onclick="location.reload()" class="book-btn">Book Another Appointment</button>
        </div>

        <button onclick="toggleDebug()" style="margin-top: 20px; padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px;">Debug</button>
        <div id="debug-panel" class="debug-panel"><div id="debug-log"></div></div>
    </div>

    <script>
        const API = 'https://1tyt5fwh61.execute-api.us-east-1.amazonaws.com';
        const stripe = Stripe('pk_test_51S7iLG1cyCy4vYhNswLFsrBUiwWKrq0pL3NvPYQHMzzPN1RgfulQmPvt6FDnLtsBmY5CT4iCCp40wzsOT2BCIdE700MWui8QaD');
        
        let currentDate = new Date();
        let selectedDate = null;
        let selectedTime = null;
        let selectedProvider = null;
        let selectedProviderName = null;
        let availableDates = new Set();
        let currentServiceId = null;
        let currentServiceData = null;
        let availableServices = [];
        let currentStep = 1;
        let paymentIntent = null;
        let cardElement = null;
        let appointmentData = {};

        function debugLog(msg, data = null) {
            const log = document.getElementById('debug-log');
            const time = new Date().toLocaleTimeString();
            log.innerHTML += `<div>[${time}] ${msg}${data ? ': ' + JSON.stringify(data) : ''}</div>`;
            log.scrollTop = log.scrollHeight;
            console.log(`[${time}] ${msg}`, data);
        }

        function toggleDebug() { 
            const p = document.getElementById('debug-panel'); 
            p.style.display = p.style.display === 'none' ? 'block' : 'none'; 
        }
        
        function showError(msg) { 
            document.getElementById('error-message').innerHTML = `<div class="error">${msg}</div>`; 
            document.getElementById('success-message').innerHTML = '';
        }
        
        function showSuccess(msg) { 
            document.getElementById('success-message').innerHTML = `<div class="success">${msg}</div>`; 
            document.getElementById('error-message').innerHTML = '';
        }
        
        function goBack() { 
            document.getElementById('service-select').value = '';
            document.getElementById('service-details').style.display = 'none';
            document.getElementById('booking-section').style.display = 'none';
            document.getElementById('payment-section').style.display = 'none';
            document.getElementById('confirmation-section').style.display = 'none';
            document.getElementById('back-btn').style.display = 'none';
            document.getElementById('error-message').innerHTML = '';
            document.getElementById('success-message').innerHTML = '';
            clearSelection();
            updateStep(1);
            debugLog('Back to services - interface reset');
        }

        function updateStep(step) {
            currentStep = step;
            for (let i = 1; i <= 4; i++) {
                const stepElement = document.getElementById(`step-${i}`);
                stepElement.classList.remove('active', 'completed');
                if (i < step) {
                    stepElement.classList.add('completed');
                } else if (i === step) {
                    stepElement.classList.add('active');
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadServices(); 
            setupEvents(); 
            renderCalendar();
            setupStripe();
        });

        function setupStripe() {
            const elements = stripe.elements();
            cardElement = elements.create('card', {
                style: {
                    base: {
                        fontSize: '16px',
                        color: '#424770',
                        '::placeholder': {
                            color: '#aab7c4',
                        },
                    },
                },
            });
            cardElement.mount('#card-element');

            cardElement.on('change', function(event) {
                const displayError = document.getElementById('card-errors');
                if (event.error) {
                    displayError.textContent = event.error.message;
                    document.getElementById('pay-btn').disabled = true;
                } else {
                    displayError.textContent = '';
                    document.getElementById('pay-btn').disabled = false;
                }
            });

            document.getElementById('payment-form').addEventListener('submit', handlePayment);
        }

        async function loadServices() {
            try {
                debugLog('Loading services...');
                const response = await fetch(`${API}/services`);
                const payload = await response.json();
                const services = Array.isArray(payload) ? payload : (Array.isArray(payload?.services) ? payload.services : []);
                const normalized = services.map(service => ({
                    service_id: service.service_id || service.id || service.pk || '',
                    name: service.name || service.title || 'Service',
                    price_cents: typeof service.price_cents === 'number' ? service.price_cents : (service.price && typeof service.price.amount === 'number' ? service.price.amount : 0),
                    description: service.description || '',
                    duration_min: typeof service.duration_min === 'number' ? service.duration_min : (typeof service.duration === 'number' ? service.duration : '')
                })).filter(service => service.service_id);

                debugLog('Services response', { status: response.status, services: normalized });
                
                if (response.ok) {
                    availableServices = normalized;
                    const select = document.getElementById('service-select');
                    select.innerHTML = '<option value="">Choose a service...</option>';
                    normalized.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.service_id;
                        opt.textContent = `${s.name} - $${(s.price_cents/100).toFixed(0)}`;
                        opt.setAttribute('data-name', s.name);
                        opt.setAttribute('data-price', s.price_cents);
                        opt.setAttribute('data-desc', s.description);
                        opt.setAttribute('data-duration', s.duration_min);
                        select.appendChild(opt);
                    });
                    debugLog('Services loaded successfully');
                } else {
                    showError('Failed to load services');
                }
            } catch (error) { 
                debugLog('Error loading services', error);
                showError('Error loading services: ' + error.message); 
            }
        }

        function setupEvents() {
            document.getElementById('service-select').addEventListener('change', function() {
                if (this.value) {
                    selectService(this.value);
                } else { 
                    document.getElementById('service-details').style.display = 'none'; 
                    document.getElementById('booking-section').style.display = 'none'; 
                    document.getElementById('back-btn').style.display = 'none';
                }
            });
            
            document.getElementById('prev-month').addEventListener('click', () => { 
                currentDate.setMonth(currentDate.getMonth() - 1); 
                renderCalendar(); 
                if (currentServiceId) loadAvailableDates(); 
            });
            
            document.getElementById('next-month').addEventListener('click', () => { 
                currentDate.setMonth(currentDate.getMonth() + 1); 
                renderCalendar(); 
                if (currentServiceId) loadAvailableDates(); 
            });
            
            document.getElementById('booking-form').addEventListener('submit', handleBookingSubmit);
        }

        function selectService(serviceId) {
            debugLog('Service selected', serviceId);
            currentServiceId = serviceId.replace('#', '%23');
            const select = document.getElementById('service-select');
            const opt = select.options[select.selectedIndex];
            
            // Store service data for later use
            currentServiceData = {
                id: serviceId,
                name: opt.getAttribute('data-name'),
                price_cents: parseInt(opt.getAttribute('data-price')),
                description: opt.getAttribute('data-desc'),
                duration_min: parseInt(opt.getAttribute('data-duration'))
            };
            
            document.getElementById('service-name').textContent = currentServiceData.name;
            document.getElementById('service-price').textContent = '$' + (currentServiceData.price_cents / 100).toFixed(0);
            document.getElementById('service-description').textContent = currentServiceData.description;
            document.getElementById('service-details').style.display = 'block';
            document.getElementById('booking-section').style.display = 'block';
            document.getElementById('back-btn').style.display = 'inline-block';
            
            clearSelection(); 
            loadAvailableDates();
            updateStep(2);
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('month-year').textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            
            const headers = grid.querySelectorAll('.day-header');
            grid.innerHTML = ''; 
            headers.forEach(h => grid.appendChild(h));
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate); 
                date.setDate(startDate.getDate() + i);
                const day = document.createElement('div');
                day.className = 'calendar-day'; 
                day.textContent = date.getDate();
                const dateStr = date.toISOString().split('T')[0];
                const isCurrentMonth = date.getMonth() === month;
                const isPast = date < new Date().setHours(0, 0, 0, 0);
                
                if (!isCurrentMonth) {
                    day.classList.add('other-month');
                } else if (isPast) {
                    day.classList.add('unavailable');
                } else { 
                    day.addEventListener('click', () => selectDate(dateStr)); 
                    day.setAttribute('data-date', dateStr); 
                }
                grid.appendChild(day);
            }
        }

        async function loadAvailableDates() {
            if (!currentServiceId) return;
            debugLog('Loading available dates for service', currentServiceId);
            
            availableDates.clear();
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                if (date < new Date().setHours(0, 0, 0, 0)) continue;
                
                try {
                    const response = await fetch(`${API}/slots?service_id=${currentServiceId}&date=${dateStr}`);
                    const result = await response.json();
                    if (response.ok && result.slots && result.slots.length > 0) {
                        availableDates.add(dateStr);
                    }
                } catch (error) { 
                    debugLog(`Error checking ${dateStr}`, error); 
                }
            }
            updateCalendarAvailability();
        }

        function updateCalendarAvailability() {
            document.querySelectorAll('.calendar-day[data-date]').forEach(el => {
                const dateStr = el.getAttribute('data-date');
                if (availableDates.has(dateStr)) { 
                    el.classList.add('available'); 
                    el.classList.remove('unavailable'); 
                } else { 
                    el.classList.add('unavailable'); 
                    el.classList.remove('available'); 
                }
            });
        }

        async function selectDate(dateStr) {
            if (!availableDates.has(dateStr)) { 
                showError('No appointments available on this date.'); 
                return; 
            }
            
            debugLog('Date selected', dateStr);
            document.querySelectorAll('.calendar-day').forEach(el => el.classList.remove('selected'));
            document.querySelector(`[data-date="${dateStr}"]`).classList.add('selected');
            selectedDate = dateStr; 
            selectedTime = null; 
            selectedProvider = null;
            selectedProviderName = null;
            
            const container = document.getElementById('times-container');
            const grid = document.getElementById('times-grid');
            container.style.display = 'block'; 
            grid.innerHTML = '<div>Loading...</div>';
            
            try {
                const response = await fetch(`${API}/slots?service_id=${currentServiceId}&date=${dateStr}`);
                const result = await response.json();
                debugLog('Slots response', result);
                
                if (response.ok && result.slots && result.slots.length > 0) {
                    displayTimeSlots(result.slots, result.providers || []);
                } else {
                    grid.innerHTML = '<div>No times available</div>';
                }
            } catch (error) { 
                debugLog('Error loading slots', error);
                grid.innerHTML = '<div>Error loading times</div>'; 
            }
        }

        function displayTimeSlots(slots, providers) {
            const grid = document.getElementById('times-grid'); 
            grid.innerHTML = '';
            const slotMap = new Map();
            
            slots.forEach(slot => {
                const utc = new Date(slot);
                const local = utc.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit', 
                    hour12: true, 
                    timeZone: 'America/Chicago' 
                });
                if (!slotMap.has(local)) {
                    slotMap.set(local, { 
                        utcTime: slot, 
                        localTime: local, 
                        providers: providers.map(p => ({ 
                            provider_id: p.provider_id, 
                            provider_name: p.provider_name, 
                            priority: p.priority 
                        })) 
                    });
                }
            });
            
            let firstSlot = true;
            Array.from(slotMap.values()).sort((a, b) => new Date(a.utcTime) - new Date(b.utcTime)).forEach(data => {
                data.providers.sort((a, b) => a.priority - b.priority);
                const slot = document.createElement('div'); 
                slot.className = 'time-slot';
                
                const defaultProvider = data.providers[0];
                const selectOptions = data.providers.map(p => 
                    `<option value="${p.provider_id}" data-name="${p.provider_name}" ${p.provider_id === defaultProvider.provider_id ? 'selected' : ''}>${p.provider_name}</option>`
                ).join('');
                
                slot.innerHTML = `<div class="time-text">${data.localTime}</div><select class="provider-dropdown" data-time="${data.utcTime}">${selectOptions}</select>`;
                grid.appendChild(slot);
                
                if (firstSlot && defaultProvider) {
                    slot.classList.add('selected');
                    selectedTime = data.utcTime;
                    selectedProvider = defaultProvider.provider_id;
                    selectedProviderName = defaultProvider.provider_name;
                    document.getElementById('patient-info').style.display = 'block';
                    document.getElementById('book-btn').disabled = false;
                    document.getElementById('book-btn').textContent = `Continue to Payment`;
                    firstSlot = false;
                }
            });
            
            document.querySelectorAll('.provider-dropdown').forEach(dropdown => {
                dropdown.addEventListener('change', e => {
                    const time = dropdown.getAttribute('data-time');
                    const providerId = dropdown.value;
                    const providerName = dropdown.options[dropdown.selectedIndex].getAttribute('data-name');
                    selectProvider(time, providerId, providerName, dropdown);
                });
            });
        }

        function selectProvider(time, providerId, providerName, dropdown) {
            document.querySelectorAll('.provider-dropdown').forEach(el => { 
                if (el !== dropdown) { 
                    el.value = ''; 
                    el.closest('.time-slot').classList.remove('selected'); 
                } 
            });
            document.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected'));
            
            dropdown.closest('.time-slot').classList.add('selected');
            selectedTime = time; 
            selectedProvider = providerId;
            selectedProviderName = providerName;
            document.getElementById('patient-info').style.display = 'block';
            document.getElementById('book-btn').disabled = false;
            document.getElementById('book-btn').textContent = `Continue to Payment`;
            
            debugLog('Provider selected', { time, providerId, providerName });
        }

        function clearSelection() {
            selectedTime = null; 
            selectedProvider = null;
            selectedProviderName = null;
            document.getElementById('patient-info').style.display = 'none';
            document.getElementById('book-btn').disabled = true;
            document.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected'));
        }

        async function handleBookingSubmit(e) {
            e.preventDefault();
            const email = document.getElementById('patient-email').value;
            
            if (!selectedDate || !selectedTime || !selectedProvider || !email) { 
                showError('Please complete all fields.'); 
                return; 
            }

            // Store appointment data for payment
            appointmentData = {
                service_id: currentServiceData.id,
                start_iso: selectedTime,
                patient_email: email,
                provider_id: selectedProvider
            };

            // Show payment section
            document.getElementById('booking-section').style.display = 'none';
            document.getElementById('payment-section').style.display = 'block';
            
            // Populate summary
            document.getElementById('summary-service').textContent = currentServiceData.name;
            document.getElementById('summary-datetime').textContent = new Date(selectedTime).toLocaleString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long', 
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                timeZone: 'America/Chicago'
            });
            document.getElementById('summary-provider').textContent = selectedProviderName;
            document.getElementById('summary-total').textContent = `$${(currentServiceData.price_cents / 100).toFixed(2)}`;
            
            updateStep(3);

            // Create payment intent
            try {
                debugLog('Creating payment intent', appointmentData);
                const response = await fetch(`${API}/create-payment-intent`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(appointmentData)
                });

                const result = await response.json();
                debugLog('Payment intent response', result);

                if (response.ok) {
                    paymentIntent = result;
                    document.getElementById('pay-btn').disabled = false;
                } else {
                    showError('Failed to prepare payment: ' + result.error);
                }
            } catch (error) {
                debugLog('Payment intent error', error);
                showError('Payment preparation failed: ' + error.message);
            }
        }

        async function handlePayment(e) {
            e.preventDefault();
            
            if (!paymentIntent) {
                showError('Payment not ready. Please try again.');
                return;
            }

            const submitButton = document.getElementById('pay-btn');
            const buttonText = document.getElementById('button-text');
            
            submitButton.disabled = true;
            buttonText.textContent = 'Processing...';

            try {
                debugLog('Confirming payment with Stripe', { clientSecret: paymentIntent.client_secret });
                
                const {error, paymentIntent: confirmedPayment} = await stripe.confirmCardPayment(
                    paymentIntent.client_secret,
                    {
                        payment_method: {
                            card: cardElement,
                            billing_details: {
                                email: appointmentData.patient_email,
                            },
                        }
                    }
                );

                if (error) {
                    debugLog('Stripe payment error', error);
                    showError('Payment failed: ' + error.message);
                    submitButton.disabled = false;
                    buttonText.textContent = 'Pay Now';
                } else {
                    debugLog('Payment succeeded', confirmedPayment);
                    
                    // Confirm with backend
                    const confirmResponse = await fetch(`${API}/confirm-payment`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            payment_intent_id: confirmedPayment.id,
                            appointment_id: paymentIntent.appointment_id
                        })
                    });

                    const confirmResult = await confirmResponse.json();
                    debugLog('Payment confirmation response', confirmResult);

                    if (confirmResponse.ok) {
                        // Show confirmation
                        document.getElementById('payment-section').style.display = 'none';
                        document.getElementById('confirmation-section').style.display = 'block';
                        document.getElementById('confirmation-id').textContent = confirmResult.appointment_id;
                        updateStep(4);
                        showSuccess('Payment successful! Your appointment is confirmed.');
                    } else {
                        showError('Payment processed but confirmation failed: ' + confirmResult.error);
                    }
                }
            } catch (error) {
                debugLog('Payment processing error', error);
                showError('Payment processing failed: ' + error.message);
                submitButton.disabled = false;
                buttonText.textContent = 'Pay Now';
            }
        }
    </script>
</body>
</html>
